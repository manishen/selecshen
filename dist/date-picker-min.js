var Selection=function(t){var e="selection",n=".ma.selection",a=t.fn[e],i=(new RegExp("38|40|27"),{HIDE:"hide"+n,HIDDEN:"hidden"+n,SHOW:"show"+n,SHOWN:"shown"+n,CHANGE:"changed"+n,CLICK:"click"+n,CLICK_ITEM:"click.ma.selection.item",CLICK_BTN_CLEAN:"click.ma.selection.btn.clean",CLICK_RESET:"click.ma.selection.btn.reset",CLICK_NEW:"click.ma.selection.btn.new",CLICK_DATA_API:"click.ma.selection.data-api",KEYDOWN_DATA_API:"keydown.ma.selection.data-api",KEYUP_DATA_API:"keyup.ma.selection.data-api"}),s="disabled",r="show",l="checked",o="hide",h="min",p="max",_=".selection-caption",g='[data-toggle="selection"]',c=".selection-btn.clean",f=".selection-dropdown",u=".selection-input",m=".selection-input.min",d=".selection-input.max",v=".selection-list",y=".selection-item",b=".selection-item.hide",C=".selection-item:not(.hide)",A=".selection-item.checked",w=".selection-action.reset",L=".selection-action.new",N="input:hidden.value",D=function(){function e(t,n){this._element=t,this._config=this._getConfig(n),this._parent=e._getParentFromElement(t),this._dropdown=this._getDropdownElement(),this._list=this._getListElement(),this._minItem=null,this._maxItem=null,this._memory={min:"",max:"",selectedItems:[]},this._addEventListeners(),this._setLabel(),this._toggleCleanButton(),this._element.setAttribute("tabindex","0")}return e.prototype.toggle=function(){if(!this._element.disabled&&!t(this._element).hasClass(s)){var n=e._getParentFromElement(this._element),a=this._dropdown.hasClass(r);if(e._clearLists(),this._toggleCleanButton(),a)this._refreshValueInputs();else{var l={relatedTarget:this._element},o=t.Event(i.SHOW,l);if(t(n).trigger(o),!o.isDefaultPrevented()){var _=this._element;this._element.focus(),_.setAttribute("aria-expanded","true"),t(this._dropdown).toggleClass(r),t(n).toggleClass(r).trigger(t.Event(i.SHOWN,l)),this._config.type&&"range"===this._config.type&&t(this._list).addClass(h).removeClass(p);var g=t(this._parent).find(u);g.length&&g[0].focus(),this._saveMemory()}}}},e.prototype.toggleItem=function(e){if(void 0!==this._config.type)switch(this._config.type){case"single":this._unchekedItems(),t(e).toggleClass(l),this.toggle();break;case"multiple":var n=t.makeArray(t(this._list).find(A+"[data-similar="+e.getAttribute("data-similar")+"]"));if(console.log(n.length),!t(e).hasClass(l)&&this._config.selectedLimit&&n.length>=this._config.selectedLimit)return;0===n.length&&this._unchekedItems(),t(e).toggleClass(l);break;case"range":if(this._unchekedItems(),t(e).toggleClass(l),t(this._list).hasClass(h)){t(this._list).addClass(p).removeClass(h);var a=t(this._parent).find(d);a.length&&a[0].focus(),t(this._parent).find(m).val(Number(e.getAttribute("data-text")).toLocaleString("en")),this._minItem=e}else t(this._list).hasClass(p)&&(t(this._parent).find(d).val(Number(e.getAttribute("data-text")).toLocaleString("en")),this._maxItem=e,this.toggle())}this._toggleCleanButton(),this._setCaption()},e.prototype.dispose=function(){},e.prototype.reset=function(){if(void 0!==this._config.type){switch(this._config.type){case"range":var e=t(this._parent).find(m),n=t(this._parent).find(d);e.val(this._memory.min),n.val(this._memory.max),this._minItem=null,this._maxItem=null;var a=t.makeArray(t(this._list).find(y));for(var i in a)a[i].getAttribute("data-text")===e.val()&&(this._minItem=a[i]),a[i].getAttribute("data-text")===n.val()&&(this._maxItem=a[i]);break;case"multiple":case"single":this._unchekedItems(),t(this._memory.selectedItems).addClass(l)}this._clearSearch(),this.toggle()}},e.prototype.new=function(){this._newItem()},e.prototype.clean=function(){this._unchekedItems();for(var e=t(this._parent).find(u),n=0;n<e.length;n++)e[n].value="";this._refreshValueInputs(),this._setLabel(),this._toggleCleanButton()},e.prototype.refresh=function(){this._setCaption(),this._refreshValueInputs(!0),this._toggleCleanButton()},e.prototype._addEventListeners=function(){var n=this;t(this._element).on(i.CLICK,function(t){t.stopPropagation(),t.preventDefault(),n.toggle()}),t(this._element).on(i.CLICK_BTN_CLEAN,c,function(t){t.preventDefault(),t.stopPropagation(),n.clean(),e._clearLists()}),t(this._parent).on("keyup",u,function(t){t.preventDefault(),t.stopPropagation(),n._search(this,t)}),t(this._parent).on("keydown",m,d,function(e){if(!(-1!==t.inArray(e.keyCode,[46,8,9,27,13,110,190])||65==e.keyCode&&(!0===e.ctrlKey||!0===e.metaKey)||67==e.keyCode&&(!0===e.ctrlKey||!0===e.metaKey)||88==e.keyCode&&(!0===e.ctrlKey||!0===e.metaKey)||e.keyCode>=35&&e.keyCode<=39))return-1!==t.inArray(e.key,["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"])?(e.preventDefault(),void(this.value=this.value.concat(String(e.keyCode-48)))):void((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault())}),t(this._parent).on(i.CLICK_ITEM,y,function(t){t.preventDefault(),t.stopPropagation(),n.toggleItem(t.target)}),t(this._parent).on("focus",u,function(e){if(e.preventDefault(),e.stopPropagation(),void 0!==n._config.type)switch(n._config.type){case"range":t(e.target).hasClass(h)&&(t(n._parent).find(v).addClass(h).removeClass(p),n._unchekedItems(),n._minItem&&n._minItem.getAttribute("data-text")==e.target.value&&t(n._minItem).toggleClass(l)),t(e.target).hasClass(p)&&(t(n._parent).find(v).addClass(p).removeClass(h),n._unchekedItems(),n._maxItem&&n._maxItem.getAttribute("data-text")==e.target.value&&t(n._maxItem).toggleClass(l))}}),t(this._parent).on(i.CLICK_RESET,w,function(t){t.preventDefault(),t.stopPropagation(),n.reset()}),t(this._parent).on(i.CLICK_NEW,L,function(t){t.preventDefault(),t.stopPropagation(),n.new()})},e.prototype._getConfig=function(e){var n=t(this._element).data();return void 0!==n.placement&&(n.placement=AttachmentMap[n.placement.toUpperCase()]),e=t.extend({},this.constructor.Default,t(this._element).data(),e)},e.prototype._getDropdownElement=function(){if(!this._dropdown){var n=e._getParentFromElement(this._element);this._dropdown=t(n).children(f)}return this._dropdown},e.prototype._getListElement=function(){if(!this._list){var n=e._getParentFromElement(this._element);this._list=t(n).find(v)}return this._list},e.prototype._getCleanButtonElement=function(){var e=this._parent,n=t(e).find(c);if(n.length>0)return n[0]},e.prototype._unchekedItems=function(){for(var e=t(this._list).children(A),n=0;n<e.length;n++)t(e[n]).removeClass(l)},e.prototype._setCaption=function(){var e=t(this._list).find(A),n=t(this._parent).find(_).html("");switch(this._element.getAttribute("data-type")){case"single":e.length?(n.html(""),void 0!==this._config.showlabel&&"true"===this._config.showlabel&&n.append('<span class="selection-label">'+this._config.label+"</span>"),n.append('<span class="selection-tag">'+e[0].getAttribute("data-text")+"</span>")):this._setLabel();break;case"multiple":if(e.length){n.html("");for(var a=0;a<e.length&&a<3;a++)n.append('<span class="selection-tag">'+e[a].getAttribute("data-text")+"</span>");e.length>3&&(n.html(""),n.append('<span class="selection-label">'+this._config.label+"</span>"),n.append('<span class="selection-tag number">'+e.length+"</span>"))}else this._setLabel();break;case"range":var i=t(this._parent).find(m),s=t(this._parent).find(d);i=i.length?i.val().replace(/[,]*/g,""):void 0,s=s.length?s.val().replace(/[,]*/g,""):void 0,this._toggleCleanButton();var r=0,l=0,o="";if(void 0!==this._config.unit)switch(this._config.unit){case"money":r=this._shortMoneyNumber(i),l=this._shortMoneyNumber(s),o="تومان";break;case"area":r=this._shortAreaNumber(i),l=this._shortAreaNumber(s),o="";break;case"age":r=this._shortAgeNumber(i),l=this._shortAgeNumber(s),o=""}var h=r.unit,p=l.unit;if(h===p&&(h=""),n.html(""),n.append('<span class="selection-label">'+this._config.label+"</span>"),i){s||n.append('<span class="selection-tag">از</span>');var g=Number(r.num);n.append(t('<span class="selection-tag">').html(isNaN(g)?r.num:g.toLocaleString("en"))),""!==h&&n.append(t('<span class="selection-tag">').html(h))}if(s){var c=Number(l.num);n.append('<span class="selection-tag">تا</span>'),n.append(t('<span class="selection-tag">').html(isNaN(c)?l.num:c.toLocaleString("en"))),n.append(t('<span class="selection-tag">').html(p))}""!==o&&n.append('<span class="selection-tag">'+o+"</span>"),i||s||(this._setLabel(),this._unchekedItems())}},e.prototype._setLabel=function(){this._config.label&&t(this._parent).find(_).html(this._config.label)},e.prototype._refreshValueInputs=function(e){var n,a,s,r,l=0,o=!1,h={relatedTarget:this._element},p=t.Event(i.CHANGE,h),_=t.makeArray(t(this._parent).find(N).remove());if(_.length)for(r={},a=0;a<_.length;a++)r[_[a].name]=_[a].value;if(void 0!==this._config.type){switch(this._config.type){case"range":var g=t(this._parent).find(m),c=t(this._parent).find(d);g.val()&&t(this._parent).append(t('<input type="hidden" class="value">').attr("name","min_"+this._element.getAttribute("data-name")).val(t(this._parent).find(m).val().replace(/[,]*/g,""))),c.val()&&t(this._parent).append(t('<input type="hidden" class="value">').attr("name","max_"+this._element.getAttribute("data-name")).val(t(this._parent).find(d).val().replace(/[,]*/g,"")));var f=r?r["min_"+this._element.getAttribute("data-name")]:"";g.val().replace(/[,]*/g,"")!==f&&(o=o||!0);var u=r?r["max_"+this._element.getAttribute("data-name")]:"";c.val().replace(/[,]*/g,"")!==u&&(o=o||!0);break;case"multiple":if(l=0,(n=t.makeArray(t(this._list).find(A))).length){for(a in n)for(s in t(this._parent).append(t('<input type="hidden" class="value">').attr("name",this._element.getAttribute("data-name")+"[]").val(n[a].getAttribute("data-value"))),_)_[s].value===n[a].getAttribute("data-value")&&(_.splice(s,1),l++);(_.length>=l||n.length>l)&&(o=!0)}else _.length&&(o=!0);break;case"single":if(l=0,(n=t.makeArray(t(this._list).find(A))).length){for(a in n)for(s in t(n[a]).hasClass("item-new")?t(this._parent).append(t('<input type="hidden" class="value">').attr("name","new_"+this._element.getAttribute("data-name")).val(n[a].getAttribute("data-value"))):t(this._parent).append(t('<input type="hidden" class="value">').attr("name",this._element.getAttribute("data-name")).val(n[a].getAttribute("data-value"))),_)_[s].value===n[a].getAttribute("data-value")&&(_.splice(s,1),l++);(_.length>=l||n.length>l)&&(o=!0)}else _.length&&(o=!0)}o&&void 0===e&&t(this._parent).trigger(p)}},e.prototype._toggleCleanButton=function(){if(void 0!==this._config.cleanable&&!1!==this._config.cleanable&&void 0!==this._config.type){var e=this._getCleanButtonElement();switch(t(e).removeClass(r),this._config.type){case"range":var n=t(this._parent).find(m),a=t(this._parent).find(d);if(n.val()||a.val())return void t(e).addClass(r);break;case"multiple":case"single":t(this._list).find(A).length>0&&t(e).addClass(r)}}},e.prototype._saveMemory=function(){if(void 0!==this._config.type)switch(this._config.type){case"range":var e=t(this._parent).find(m),n=t(this._parent).find(d);this._memory.min=e?e.val():null,this._memory.max=n?n.val():null;break;case"multiple":case"single":this._memory.selectedItems=t.makeArray(t(this._list).find(A))}},e.prototype._search=function(n,a){if(void 0!==this._config.type){var i=[],s=0,l="",h=String(n.value);switch(this._config.type){case"range":if(h=h.replace(/[,]*/g,""),isNaN(Number(h))||""===h)return;l=Number(h).toLocaleString("en"),n.value=l;break;case"multiple":case"single":for(s in i=t.makeArray(this._list.find(y)),h=h.replace(/[ ]*/g,"").toLowerCase(),i)l=i[s].getAttribute("data-text").replace(/[ ]*/g,"").toLowerCase(),(l+=e._convertToLatinChar(l)).indexOf(h)>-1?t(i[s]).removeClass(o):t(i[s]).addClass(o);0===t(this._parent).find(C).length?t(this._parent).find(L).addClass(r):t(this._parent).find(L).removeClass(r)}}},e.prototype._shortMoneyNumber=function(t){if(isNaN(Number(t)))return{num:0,unit:"",real:0};var e=0;return t>=1e9?{num:(e=t/1e9)==parseInt(e)?String(e):parseFloat(e),unit:"میلیارد",real:t}:t>=1e6?{num:(e=t/1e6)==parseInt(e)?String(e):parseFloat(e),unit:"میلیون",real:t}:t>=1e3?{num:(e=t/1e3)==parseInt(e)?String(e):parseFloat(e),unit:"هزار",real:t}:{num:t,unit:"",real:t}},e.prototype._shortAreaNumber=function(t){if(isNaN(Number(t)))return{num:0,unit:"",real:0};return t>=1e4?{num:t/1e4,unit:"هکتار",real:t}:t>=1e3?{num:t/1e3,unit:"هزار متر",real:t}:{num:t,unit:"متر",real:t}},e.prototype._shortAgeNumber=function(t){if(isNaN(Number(t)))return{num:0,unit:"",real:0};return 0===Number(t)?{num:"نوساز",unit:"",real:t}:{num:t,unit:"سال",real:t}},e.prototype._clearSearch=function(){if(void 0!==this._config.type)switch(this._config.type){case"multiple":case"single":t(this._parent).find(u).val(""),t(this._list).find(b).removeClass(o)}},e.prototype._newItem=function(){if(void 0!==this._config.type)switch(this._config.type){case"multiple":case"single":var e=t(this._parent).find(u).val();t(this._parent).find(u).val(""),t(this._list).find(b).removeClass(o);var n=t('<li class="selection-item item-new" data-value="'+e+'" data-text="'+e+'">'+e+"</li>");t(this._list).append(n),this.toggleItem(n)}},e._jQueryInterface=function(n){return this.each(function(){var a=t(this).data("ma.selection");if(a||(a=new e(this,"object"==(void 0===n?"undefined":typeof n)?n:null),t(this).data("ma.selection",a)),"string"==typeof n){if(void 0===a[n])throw new Error('No method named "'+n+'"');a[n]()}})},e._clearLists=function(n){if(!n||3!==n.which&&("keyup"!==n.type||9===n.which))for(var a=t.makeArray(t(g)),s=0;s<a.length;s++){var l=e._getParentFromElement(a[s]),o=t(a[s]).data("ma.selection"),h={relatedTarget:a[s]};if(o){var p=o._dropdown;if(t(l).hasClass(r)&&!(n&&("click"===n.type&&/input|textarea/i.test(n.target.tagName)||"keyup"===n.type&&9===n.which)&&t.contains(l,n.target))){var _=t.Event(i.HIDE,h);t(l).trigger(_),_.isDefaultPrevented()||("ontouchstart"in document.documentElement&&t("body").children().off("mouseover",null,t.noop),a[s].setAttribute("aria-expanded","false"),t(p).removeClass(r),t(l).removeClass(r).trigger(t.Event(i.HIDDEN,h)),e._jQueryInterface.call(t(a[s]),"_refreshValueInputs"),e._jQueryInterface.call(t(a[s]),"_setCaption"),e._jQueryInterface.call(t(a[s]),"_clearSearch"))}}}},e._getParentFromElement=function(t){return t.parentNode},e._dataApiKeydownHandler=function(n){if(!this.disabled&&!t(this).hasClass(s)){var a=e._getParentFromElement(this),i=t(a).hasClass(r),l=t(a).find(g)[0];if(i||32!==n.which&&40!==n.which||!n.target.hasAttribute("data-toggle"))return i&&27===n.which?(t(l).trigger("focus"),void t(l).trigger("click")):void 0;t(l).trigger("click")}},e._convertToLatinChar=function(e){for(var n=["ا","ب","پ","ت","ث","ج","چ","ح","خ","د","ذ","ر","ز","ژ","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ک","گ","ل","م","ن","و","ه","ی","آ","ء","إ","أ","ي","ة","-‌","۱","۲","۳","۴","۵","۶","۷","۸","۹","۰"],a=["h","f","m","j","e","[","]","p","o","n","b","v","c","c","s","a","w","q","x","z","u","y","t","r",";","'","g","l","k",",","i","d","h","m","f","g","d","j","-‌","1","2","3","4","5","6","7","8","9","0"],i=0,s="",r=0;r<e.length;r++)(i=t.inArray(e[r],n))>=0&&(s+=a[i]);return s},e}();return t(document).on(i.KEYDOWN_DATA_API,g,D._dataApiKeydownHandler).on(i.KEYDOWN_DATA_API,f,D._dataApiKeydownHandler).on(i.CLICK_DATA_API+" "+i.KEYUP_DATA_API,D._clearLists).on(i.CLICK_DATA_API,g,function(e){e.preventDefault(),e.stopPropagation(),D._jQueryInterface.call(t(this),"toggle")}),t.fn[e]=D._jQueryInterface,t.fn[e].Constructor=D,t.fn[e].noConflict=function(){return t.fn[e]=a,D._jQueryInterface},D}(jQuery);